from scipy.stats import rankdata
from utils.data_handler import get_data, continue_or_exit

def wilcoxon_mann_whitney_test():
    """
    Виконує тест Вілкоксона-Манна-Уітні (також відомий як U-тест Манна-Уітні)
    для порівняння двох незалежних вибірок.
    
    Цей тест є непараметричною альтернативою t-тесту для незалежних вибірок.
    """
    print("\n\033[92m--- ТЕСТ ВІЛКОКСОНА-МАННА-УІТНІ ---\033[0m")
    print("Цей тест порівнює дві незалежні вибірки без припущення про нормальність розподілу.")
    
    # Отримуємо дані
    print("\n\033[93mПерша вибірка:\033[0m")
    d1, n1, _ = get_data("Введіть значення для першої вибірки (через пробіл): ")   
    print("\n\033[93mДруга вибірка:\033[0m")
    d2, n2, _ = get_data("Введіть значення для другої вибірки (через пробіл): ")
    d = d1 + d2
    
    # Обчислюємо ранги
    rng = rankdata(d, 'average')
    
    # Розділяємо ранги назад до відповідних вибірок та обчислюємо їхні суми
    ranks_of_d1 = rng[:len(d1)]
    ranks_of_d2 = rng[len(d1):]
    rank_sum_of_d1 = sum(ranks_of_d1)
    rank_sum_of_d2 = sum(ranks_of_d2)
    
    # Визначаємо, яку групу використовувати для обчислення U
    if rank_sum_of_d1 <= rank_sum_of_d2:
        selected_group = 'перша'
        Tx = rank_sum_of_d1
        Nx = len(d1)
    else:
        selected_group = 'друга'
        Tx = rank_sum_of_d2
        Nx = len(d2)
    
    print(f"\nГрупа, обрана для обчислення U: {selected_group} вибірка")
    print(f"Сума рангів обраної групи (Tx): {Tx}")
    
    # Обчислюємо значення U
    U = (n1 * n2) + ((Nx * (Nx + 1)) / 2) - Tx
    print(f"Значення статистики U: {U}")
    
    # Встановлюємо фіксований рівень значущості 5%, оскільки таблиця містить 
    # критичні значення лише для цього рівня
    significance_level = "5%"
    print(f"\n\033[93mРівень значущості: {significance_level}\033[0m")
    
    # Таблиця критичних значень для U-тесту Манна-Уітні (alpha = 0.05)
    critical_values_map = {
        # n1=3 ряд
        (3,5): 0.0, (3,6): 1.0, (3,7): 1.0, (3,8): 2.0, (3,9): 2.0,
        (3,10): 3.0, (3,11): 3.0, (3,12): 4.0, (3,13): 4.0, (3,14): 5.0,
        (3,15): 5.0, (3,16): 6.0, (3,17): 6.0, (3,18): 7.0, (3,19): 7.0, (3,20): 8.0,
        
        # n1=4 ряд
        (4,5): 1.0, (4,6): 2.0, (4,7): 3.0, (4,8): 4.0, (4,9): 4.0,
        (4,10): 5.0, (4,11): 6.0, (4,12): 7.0, (4,13): 8.0, (4,14): 9.0,
        (4,15): 10.0, (4,16): 11.0, (4,17): 11.0, (4,18): 12.0, (4,19): 13.0, (4,20): 13.0,
        
        # n1=5 ряд
        (5,5): 2.0, (5,6): 3.0, (5,7): 5.0, (5,8): 6.0, (5,9): 7.0,
        (5,10): 8.0, (5,11): 9.0, (5,12): 11.0, (5,13): 12.0, (5,14): 13.0,
        (5,15): 14.0, (5,16): 15.0, (5,17): 17.0, (5,18): 18.0, (5,19): 19.0, (5,20): 20.0,
        
        # n1=6 ряд
        (6,6): 5.0, (6,7): 6.0, (6,8): 8.0, (6,9): 10.0, (6,10): 11.0,
        (6,11): 13.0, (6,12): 14.0, (6,13): 16.0, (6,14): 17.0, (6,15): 19.0,
        (6,16): 21.0, (6,17): 22.0, (6,18): 24.0, (6,19): 25.0, (6,20): 27.0,
        
        # n1=7 ряд
        (7,7): 8.0, (7,8): 10.0, (7,9): 12.0, (7,10): 14.0, (7,11): 16.0,
        (7,12): 18.0, (7,13): 20.0, (7,14): 22.0, (7,15): 24.0, (7,16): 26.0,
        (7,17): 28.0, (7,18): 30.0, (7,19): 32.0, (7,20): 34.0,
    }
    
    # Отримуємо критичне значення
    smaller_n = min(n1, n2)
    larger_n = max(n1, n2)
    
    if smaller_n < 3 or smaller_n > 7 or larger_n < 5 or larger_n > 20:
        print("\n\033[91mУвага: Розміри вибірок виходять за межі таблиці критичних значень.\033[0m")
        print("Для отримання точних результатів зверніться до більш повної статистичної таблиці або використовуйте scipy.stats.mannwhitneyu")
        U_critical = None
    else:
        U_critical = critical_values_map.get((smaller_n, larger_n))
    
    # Виводимо результати
    print(f"\n\033[93mРезультати тесту:\033[0m")
    print(f"Статистика U: {U}")
    
    if U_critical is not None:
        print(f"Критичне значення U (α = {significance_level}): {U_critical}")
        exit(1)
        
        if U <= U_critical:
            print("\n\033[92mВисновок: Відхиляємо нульову гіпотезу.\033[0m")
            print("Існує статистично значуща різниця між двома вибірками.")
        else:
            print("\n\033[92mВисновок: Не вдалося відхилити нульову гіпотезу.\033[0m")
            print("Недостатньо доказів для висновку про статистично значущу різницю між вибірками.")
    
    # Додаткова інформація про ранги [дебаг]
    print("\n\033[93mДетальні результати:\033[0m")
    print(f"Ранги першої вибірки: {ranks_of_d1}")
    print(f"Ранги другої вибірки: {ranks_of_d2}")
    print(f"Сума рангів першої вибірки: {rank_sum_of_d1}")
    print(f"Сума рангів другої вибірки: {rank_sum_of_d2}")
    
    return continue_or_exit()